<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>Breakout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../../css/fonts.css">
  <link rel="stylesheet" href="../../css/normalize.css">
  <link rel="stylesheet" href="../../css/skeleton.css">
  <link rel="stylesheet" href="../../css/custom.css">
  <style>
    .panel { max-width: 440px; margin: 0 auto; }
    canvas { display:block; margin:0 auto; border:1px solid #ccc; background:#fafafa; cursor:none; touch-action:none; }
    .meta { display:flex; justify-content:space-between; margin-bottom:6px; color:#555; }
    .btns { margin-top:8px; display:flex; gap:8px; justify-content:center; }
    #hint { text-align:center; color:#888; font-size:.85rem; margin-top:6px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="margin-top:2rem"><a href="../">← Към игрите</a></div>
    <div class="row panel">
      <h4>Breakout</h4>
      <div class="meta">
        <span>Точки: <strong id="score">0</strong></span>
        <span>Живота: <strong id="lives">3</strong></span>
      </div>
      <canvas id="c" width="400" height="380"></canvas>
      <div id="hint">Мишка / пръст за управление · Space за старт</div>
      <div class="btns">
        <button class="button" id="startBtn">Старт / Пауза</button>
        <button class="button" id="resetBtn">Нова игра</button>
      </div>
    </div>
  </div>
<script>
'use strict';
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const W = 400, H = 380;
const ROWS = 5, COLS = 10, BW = 36, BH = 14, BP = 4, BTOP = 48;
const COLORS = ['#e74c3c','#e67e22','#f39c12','#2ecc71','#3498db'];

let paddle, ball, bricks, score, lives, running, paused, animId;

function makeBricks() {
  const b = [];
  for (let r = 0; r < ROWS; r++)
    for (let c = 0; c < COLS; c++)
      b.push({ x: c*(BW+BP)+BP, y: r*(BH+BP)+BTOP, alive: true, color: COLORS[r] });
  return b;
}

function reset() {
  paddle = { x: W/2-40, y: H-24, w: 80, h: 10 };
  ball = { x: W/2, y: H-44, vx: 3, vy: -4, r: 7 };
  bricks = makeBricks();
  score = 0; lives = 3; running = false; paused = false;
  document.getElementById('score').textContent = '0';
  document.getElementById('lives').textContent = '3';
  if (animId) { cancelAnimationFrame(animId); animId = null; }
  draw();
}

function draw() {
  ctx.fillStyle = '#fafafa';
  ctx.fillRect(0, 0, W, H);
  bricks.forEach(b => {
    if (!b.alive) return;
    ctx.fillStyle = b.color;
    ctx.beginPath();
    ctx.roundRect(b.x, b.y, BW, BH, 3);
    ctx.fill();
  });
  ctx.fillStyle = '#2c3e50';
  ctx.beginPath();
  ctx.roundRect(paddle.x, paddle.y, paddle.w, paddle.h, 5);
  ctx.fill();
  ctx.fillStyle = '#2c3e50';
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
  ctx.fill();
  if (!running) {
    ctx.fillStyle = 'rgba(0,0,0,0.35)';
    ctx.fillRect(0, 0, W, H);
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 18px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Натисни Старт или Space', W/2, H/2);
  }
}

function tick() {
  if (!running || paused) return;
  ball.x += ball.vx; ball.y += ball.vy;
  if (ball.x - ball.r < 0) { ball.x = ball.r; ball.vx = Math.abs(ball.vx); }
  if (ball.x + ball.r > W) { ball.x = W-ball.r; ball.vx = -Math.abs(ball.vx); }
  if (ball.y - ball.r < 0) { ball.y = ball.r; ball.vy = Math.abs(ball.vy); }
  if (ball.y + ball.r >= paddle.y && ball.y - ball.r <= paddle.y+paddle.h &&
      ball.x >= paddle.x && ball.x <= paddle.x+paddle.w && ball.vy > 0) {
    ball.vy = -Math.abs(ball.vy);
    ball.vx = ((ball.x - (paddle.x+paddle.w/2)) / (paddle.w/2)) * 5;
  }
  if (ball.y - ball.r > H) {
    lives--;
    document.getElementById('lives').textContent = String(lives);
    if (lives <= 0) { running = false; endScreen('Край! Точки: '+score); return; }
    ball = { x: W/2, y: H-44, vx: (Math.random()>0.5?1:-1)*3, vy: -4, r: 7 };
  }
  for (const b of bricks) {
    if (!b.alive) continue;
    if (ball.x+ball.r > b.x && ball.x-ball.r < b.x+BW &&
        ball.y+ball.r > b.y && ball.y-ball.r < b.y+BH) {
      b.alive = false;
      const overlapLeft  = ball.x+ball.r - b.x;
      const overlapRight = b.x+BW - (ball.x-ball.r);
      const overlapTop   = ball.y+ball.r - b.y;
      const overlapBot   = b.y+BH - (ball.y-ball.r);
      if (Math.min(overlapLeft,overlapRight) < Math.min(overlapTop,overlapBot))
        ball.vx = -ball.vx;
      else
        ball.vy = -ball.vy;
      score += 10;
      document.getElementById('score').textContent = String(score);
      break;
    }
  }
  if (bricks.every(b => !b.alive)) { running = false; endScreen('Победа! Точки: '+score); return; }
  draw();
  animId = requestAnimationFrame(tick);
}

function endScreen(msg) {
  draw();
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.fillRect(0, 0, W, H);
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 22px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(msg, W/2, H/2);
}

function movePaddle(clientX) {
  const rect = canvas.getBoundingClientRect();
  const x = (clientX - rect.left) * (W / rect.width);
  paddle.x = Math.max(0, Math.min(W-paddle.w, x - paddle.w/2));
  if (!running) draw();
}

canvas.addEventListener('mousemove', e => movePaddle(e.clientX));
canvas.addEventListener('touchmove', e => { e.preventDefault(); movePaddle(e.touches[0].clientX); }, { passive: false });

document.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft')  paddle.x = Math.max(0, paddle.x-20);
  if (e.key === 'ArrowRight') paddle.x = Math.min(W-paddle.w, paddle.x+20);
  if (e.code === 'Space') { e.preventDefault(); startPause(); }
});

function startPause() {
  if (!running) { running = true; paused = false; animId = requestAnimationFrame(tick); }
  else { paused = !paused; if (!paused) animId = requestAnimationFrame(tick); }
}

document.getElementById('startBtn').onclick = startPause;
document.getElementById('resetBtn').onclick = reset;
reset();
</script>
</body>
</html>
